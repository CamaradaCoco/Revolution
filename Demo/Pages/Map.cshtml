@page "/"
@model Demo.Pages.MapModel
@{
    ViewData["Title"] = "Mapping Revolutions";
}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<div class="d-flex" style="height:700px;">
  <div id="map" style="flex:1;"></div>
</div>

<!-- Offcanvas side pane -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="revsPane" aria-labelledby="revsPaneLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="revsPaneLabel">Revolutions</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body" id="revsPaneBody" style="padding:0 1rem 1rem 1rem; overflow:auto;">
    <!-- Content populated by JS -->
    <div class="p-3 text-muted">Click a country to load revolutions since 1950.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(async function() {
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // helper: escape user-provided text for HTML
    function escapeHtml(s) {
        if (!s) return '';
        return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#39;');
    }

    // load country GeoJSON
    const geojsonUrl = 'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson';
    try {
        const g = await fetch(geojsonUrl);
        if (!g.ok) { console.warn('Could not load country GeoJSON', g.status); return; }
        const countries = await g.json();

        let loggedOnce = false;
        function pickIsoFromProps(p) {
            const candidates = ['ISO_A2','ISO_A3','iso_a2','iso_a3','ISO2','ISO_A2__','ISO_A3__','adm0_a3'];
            for (const k of candidates) {
                if (p[k]) return p[k];
            }
            for (const key of Object.keys(p)) {
                if (key.toLowerCase().includes('iso') && typeof p[key] === 'string') return p[key];
            }
            return null;
        }

        function formatDateIso(isoString) {
            if (!isoString) return '';
            try {
                const d = new Date(isoString);
                if (!isNaN(d)) return d.toLocaleDateString();
            } catch {}
            const m = isoString.match(/^(\d{4})/);
            return m ? m[1] : isoString;
        }

        function buildPaneContent(countryName, iso, items) {
            let html = `<div style="max-width:100%;">`;
            html += `<h4 style="margin:.25em 0;">${escapeHtml(countryName)}${iso ? ' (' + escapeHtml(iso) + ')' : ''}</h4>`;
            if (!items || items.length === 0) {
                html += '<div class="text-muted">No recorded revolutions since 1950.</div></div>';
                return html;
            }

            html += `<div style="max-height:60vh; overflow:auto; padding-right:6px;">`;
            items.sort((a,b) => {
                const da = a.startDate ? new Date(a.startDate).getTime() : 0;
                const db = b.startDate ? new Date(b.startDate).getTime() : 0;
                return db - da;
            });

            html += '<ul class="list-unstyled" style="margin:0;">';
            for (let i = 0; i < items.length; i++) {
                const it = items[i];
                const start = it.startDate ? formatDateIso(it.startDate) : 'unknown';
                const end = it.endDate ? formatDateIso(it.endDate) : '';
                const period = end ? `${start} — ${end}` : `${start}`;
                const wdLink = it.wikidataId ? ` <a href="https://www.wikidata.org/wiki/${encodeURIComponent(it.wikidataId)}" target="_blank" rel="noopener">Wikidata</a>` : '';
                const fullDesc = it.description ?? '';
                const shortDesc = fullDesc.length > 200 ? fullDesc.slice(0,200) + '…' : fullDesc;
                const descId = `desc-${i}-${escapeHtml(iso || 'nok')}`;

                let descHtml = '';
                if (fullDesc) {
                    // store full text encoded in data-full (encodedURIComponent) to avoid HTML injection
                    descHtml = `<div id="${descId}" data-full="${encodeURIComponent(fullDesc)}" data-showing="0" class="text-muted small" style="margin-top:.25rem;">
                                  <span class="desc-text">${escapeHtml(shortDesc)}</span>
                                  ${fullDesc.length > 200 ? ` <a href="#" class="more-link" data-target="${descId}">more</a>` : ''}
                                </div>`;
                } else {
                    descHtml = `<div class="text-muted small" style="margin-top:.25rem;">No description available.</div>`;
                }

                html += `<li style="margin-bottom:0.75rem;border-bottom:1px solid #eee;padding-bottom:.5rem;">
                           <div><strong>${escapeHtml(it.name)}</strong>${wdLink}</div>
                           <div class="small text-secondary">${escapeHtml(period)}</div>
                           ${descHtml}
                         </li>`;
            }
            html += '</ul></div></div>';
            return html;
        }

        // small iso3->iso2 map for common codes; extend if needed
        const iso3ToIso2 = {
            "USA":"US","GBR":"GB","RUS":"RU","CHN":"CN","FRA":"FR","DEU":"DE","ESP":"ES","ITA":"IT",
            "CAN":"CA","AUS":"AU","BRA":"BR","MEX":"MX","JPN":"JP","KOR":"KR","IND":"IN","IRN":"IR",
            "SYR":"SY"
        };

        async function fetchRevolutionsForIsoOrName(iso, name) {
            // 1) try iso as-is
            if (iso) {
                let url = '/api/revolutions?countryIso=' + encodeURIComponent(iso);
                let r = await fetch(url);
                if (r.ok) {
                    let list = await r.json();
                    if (Array.isArray(list) && list.length > 0) return list;
                }
                // 2) map iso3->iso2
                if (iso.length === 3) {
                    const iso2 = iso3ToIso2[iso.toUpperCase()];
                    if (iso2) {
                        let url2 = '/api/revolutions?countryIso=' + encodeURIComponent(iso2);
                        let r2 = await fetch(url2);
                        if (r2.ok) {
                            let list2 = await r2.json();
                            if (Array.isArray(list2) && list2.length > 0) return list2;
                        }
                    }
                }
            }
            // 3) fallback: try by country name
            if (name) {
                const urlName = '/api/revolutions?country=' + encodeURIComponent(name);
                let rn = await fetch(urlName);
                if (rn.ok) {
                    let listn = await rn.json();
                    if (Array.isArray(listn) && listn.length > 0) return listn;
                }
            }
            return [];
        }

        // toggle description (delegated handler will call this)
        function toggleDescription(targetId) {
            const el = document.getElementById(targetId);
            if (!el) return;
            const full = decodeURIComponent(el.dataset.full || '');
            const showing = el.dataset.showing === '1';
            const descText = el.querySelector('.desc-text');
            const link = el.querySelector('.more-link');
            if (!descText || !link) return;
            if (showing) {
                // show short
                const short = full.length > 200 ? full.slice(0,200) + '…' : full;
                descText.textContent = short;
                link.textContent = 'more';
                el.dataset.showing = '0';
            } else {
                // show full
                descText.textContent = full;
                link.textContent = 'less';
                el.dataset.showing = '1';
            }
        }

        // event delegation for more/less links
        document.getElementById('revsPaneBody').addEventListener('click', function(e) {
            const a = e.target.closest && e.target.closest('.more-link');
            if (a) {
                e.preventDefault();
                const target = a.getAttribute('data-target');
                if (target) toggleDescription(target);
            }
        });

        // add countries layer; clicking opens offcanvas instead of popup
        L.geoJSON(countries, {
            style: () => ({ color: '#3388ff', weight: 1, fillOpacity: 0.05 }),
            onEachFeature: (feature, layer) => {
                if (!loggedOnce) { console.log('Example country.properties:', feature.properties); loggedOnce = true; }
                layer.on('click', async (e) => {
                    const props = feature.properties || {};
                    const name = props.ADMIN || props.NAME || props.name || '';
                    const iso = pickIsoFromProps(props);
                    if (!iso) {
                        // show a minimal pane message
                        const body = document.getElementById('revsPaneBody');
                        body.innerHTML = `<div class="p-3"><strong>${escapeHtml(name)}</strong><div class="text-muted">No ISO available for lookup.</div></div>`;
                        var off = new bootstrap.Offcanvas(document.getElementById('revsPane'));
                        off.show();
                        return;
                    }

                    // fetch items
                    const list = await fetchRevolutionsForIsoOrName(iso, name);

                    // normalize fields for display
                    const safeList = Array.isArray(list) ? list.map(i => ({
                        name: i.name ?? '(unnamed)',
                        startDate: i.startDate ?? null,
                        endDate: i.endDate ?? null,
                        description: i.description ?? '',
                        wikidataId: i.wikidataId ?? null
                    })) : [];

                    const content = buildPaneContent(name || iso, iso, safeList);
                    const body = document.getElementById('revsPaneBody');
                    body.innerHTML = content;
                    var off = new bootstrap.Offcanvas(document.getElementById('revsPane'));
                    off.show();
                });
            }
        }).addTo(map);

    } catch (ex) {
        console.error('Error loading countries GeoJSON', ex);
    }
})();
</script>
